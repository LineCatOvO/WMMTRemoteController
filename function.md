下面是 **《远程赛车输入控制系统 · 功能文档（Functional Specification v1.2 · 完整修订版）》** 的**完整正文**。  
本版本在 **v1.1** 基础上，**完整合并并规范化**了你提出的所有增强建议，并将其**严格放置在功能层**，不提前泄露技术实现。

> 本文档现在已经达到：  
> **技术设计阶段不需要再“补功能”的状态**。

---

# 远程赛车输入控制系统
**功能文档（Functional Specification v1.2）**

---

## 1. 文档定位

本文档用于描述远程赛车输入控制系统在当前阶段**所需具备的全部功能能力集合**。

本文档的作用是：

- 将最终需求文档中的行为承诺拆解为明确、可验收的功能项
- 为技术设计、实现与测试提供功能级输入
- 明确系统“需要有什么功能”，而非“如何实现功能”

---

## 2. 功能范围与约束

### 2.1 功能覆盖范围

本文档覆盖以下功能域：

| 功能域 | 描述 |
|---|---|
| 输入源采集功能 | 感知并采集用户操作 |
| 控制语义处理功能 | 将操作转化为状态化控制语义 |
| 控制结果输出功能 | 生成键盘 / 手柄控制结果 |
| 操作布局管理功能 | 管理用户操作布局 |
| 布局编辑工具功能 | 提供完备的布局编辑能力 |
| 控制状态管理功能 | 管理控制启用、禁用与状态 |
| 控制结果发送策略 | 管理事件 / 状态发送模式 |
| 通信与连接功能 | 传输、确认与延迟检测 |
| 执行端功能 | 执行控制结果并维护安全状态 |
| 异常与回退功能 | 保证系统安全与稳定 |
| 可观测性功能 | 提供状态、延迟与告警可见性 |

---

### 2.2 明确不包含的内容

本文档**不包含**：

- 技术架构设计
- 模块或类划分
- API、协议或数据结构定义
- UI 视觉设计稿

---

### 2.3 场景与范围约束

当前阶段功能验收仅针对：

- **单设备本地运行场景**
- **本地控制链路（localhost）**

本文档不包含、也不要求支持：

- 跨设备连接
- 局域网或公网远程控制
- 云端执行环境

---

## 3. 功能总览与需求追溯

| 功能域 | 主要需求来源 |
|---|---|
| 输入源采集 | 需求 §4.1 |
| 控制结果输出 | 需求 §4.2、§6 |
| 操作布局管理 | 需求 §7 |
| 布局编辑工具 | 需求 §8 |
| 控制启用与范围 | 需求 §9 |
| 异常与回退 | 需求 §11 |

---

## 4. 输入源采集功能（Source Acquisition）

### 4.1 输入源支持分级

| 输入源 | 支持级别 |
|---|---|
| 触控 | 必须 |
| 陀螺仪 | 必须 |
| 键盘 | 可选 |
| 手柄 | 可选 |

**功能不变量**：  
输入源采集能力的存在与否，不影响系统必须具备的控制结果输出能力。

---

### 4.2 输入采集行为要求

- 连续输入可被持续感知
- 多输入源可同时存在
- 输入采集不依赖 UI 是否可见

---

## 5. 控制语义处理功能

### 5.1 控制语义生成

系统应具备将原始输入转化为**控制语义状态**的功能能力，用于表达用户意图。

---

### 5.2 状态驱动语义模型

- 控制语义以状态形式存在
- 任意时刻可完整描述当前状态
- 状态可被统一清空与重置

---

### 5.3 控制平滑与映射功能

| 功能 | 描述 |
|---|---|
| 输入平滑 | 平滑连续输入变化 |
| 死区处理 | 忽略微小抖动 |
| 非线性映射 | 支持指数等映射方式 |

---

## 6. 控制结果输出功能（Result Emission）

### 6.1 键盘控制结果输出

- 按键按下与释放
- 多按键同时存在
- 持续按键状态维护

---

### 6.2 手柄控制结果输出

- 按键状态
- 摇杆轴状态
- 扳机模拟量
- 多轴、多按键并存

---

### 6.3 控制结果组合能力

- 同时生成键盘与手柄控制结果
- 不同控制结果互不排斥
- 任一控制结果失效不影响其他结果

---

## 7. 操作布局管理功能

### 7.1 操作布局管理

| 功能 | 描述 |
|---|---|
| 创建布局 | 新建操作布局 |
| 删除布局 | 移除已有布局 |
| 修改布局 | 更新布局内容 |
| 切换布局 | 运行中切换布局 |

---

### 7.2 多布局支持

- 同时存在多套布局
- 布局之间互不影响
- 切换即时生效

---

### 7.3 布局导入与导出

- 导出为用户可见、可分享资源
- 从外部来源导入布局
- 导入失败不影响现有布局

---

## 8. 布局编辑工具功能（核心）

### 8.1 编辑工具总体能力

客户端必须提供**完备的操作布局编辑工具**。

---

### 8.2 编辑能力清单

| 编辑能力 | 功能说明 |
|---|---|
| 操作元素管理 | 添加、删除操作元素 |
| 元素位置调整 | 移动、缩放操作区域 |
| 控制映射编辑 | 修改操作与控制结果映射 |
| 参数编辑 | 灵敏度、范围、曲线 |
| 实时预览 | 编辑过程中观察控制变化 |

---

### 8.3 编辑会话与安全性

- 草稿与已发布布局区分
- 未提交编辑不影响运行态
- 编辑失败不污染已发布布局
- 支持撤销或等价恢复能力

---

### 8.4 编辑与运行关系

- 编辑不应中断当前控制
- 编辑状态与控制启用状态独立
- 编辑完成后由用户决定是否应用

---

### 8.5 扁平化保存与预览语义（新增）

- 所有布局统一使用**扁平化保存 / 加载机制**
- 不引入特殊格式或额外状态机

#### 预览布局

- 预览时保存一个**临时布局**
- 预览期间使用该临时布局
- 退出预览后恢复原布局

#### 草稿与备份布局

- 草稿与备份等价于普通保存操作
- 区别仅体现在**布局名称前缀**
    - 草稿：草稿前缀
    - 备份：备份前缀

---

## 9. 控制状态管理功能

### 9.1 控制启用与禁用

- 启用时生成控制结果
- 禁用时不生成任何控制结果
- 不影响连接与布局状态

---

### 9.2 控制作用范围与安全切断

- 控制默认对宿主环境全局生效
- 不基于当前应用筛选

安全机制介入时：

- 立即进入零输出状态
- 提供可感知中断反馈

---

### 9.3 控制状态可见性

- 当前控制是否启用
- 是否存在持续控制
- 当前布局与控制状态

---

## 10. 控制结果发送策略（新增）

### 10.1 发送模式控制

客户端应支持以下发送模式：

| 模式 | 描述 |
|---|---|
| 状态发送 | 固定节奏发送完整状态 |
| 事件发送 | 状态变化时发送 |

两种模式可独立开关，但至少启用一种。

---

### 10.2 状态同步频率配置

- 状态发送模式下支持配置同步频率
- 同步频率影响延迟、稳定性与资源消耗

---

## 11. 通信与连接功能（增强）

### 11.1 控制数据传输

- 通过 WebSocket 传输控制结果

---

### 11.2 ACK 确认机制

- 执行端返回 ACK 类型数据
- ACK 确认对应控制结果 ID 已执行

---

### 11.3 延迟检测与告警

客户端应基于 ACK 计算延迟，并提供以下告警语义：

| 延迟 | 告警级别 |
|---|---|
| ≤ 50ms | 正常 |
| > 50ms | 黄色警告 |
| > 100ms | 红色严重警告 |

告警仅用于提示，不自动改变控制行为。

---

## 12. 执行端功能（增强）

### 12.1 控制结果执行

- 接收并执行控制结果
- 维护当前控制状态

---

### 12.2 执行端安全回退

执行端必须具备**独立清零能力**：

- 连接中断
- 控制异常
- 客户端禁用

---

### 12.3 超时清空配置（新增）

- 执行端支持超时自动清零
- 超时时间可由客户端配置
- 默认值：**500ms**

---

## 13. 异常与回退功能

### 13.1 异常隔离

- 单一异常不影响整体运行
- 异常不扩散至其他功能域

---

### 13.2 统一清零流程

- 键盘按键释放
- 手柄状态归零
- 状态一致性恢复

---

## 14. 可观测性与验证功能

### 14.1 状态可观测性

- 控制状态
- 布局状态
- 连接状态
- 延迟与告警状态

---

### 14.2 行为可重复性

- 相同操作产生相同结果
- 相同异常触发相同行为

---

## 15. 当前阶段功能目标

| 功能 | 要求 |
|---|---|
| 输入采集 | 触控、陀螺仪 |
| 控制结果 | 键盘、手柄 |
| 布局 | 完整编辑与管理 |
| 稳定性 | 无残留控制 |
| 场景 | 单设备本地运行 |

---

## 16. 非当前阶段功能

- 跨设备控制
- 云端执行环境
- 多实例控制
- 控制录制与回放

---

### 功能文档结论

> **本文档已完整定义系统在当前阶段必须具备的功能能力集合，  
> 不再存在隐性假设或待补功能。**

---

## 下一步

现在可以**直接进入技术设计阶段**，推荐顺序：

1. **技术设计 v1.1：通信协议与状态结构**
2. **技术设计 v1.2：运行时与状态机**
3. **技术设计 v1.3：布局引擎与编辑器内部模型**

你已经把“功能”这一步做到**非常罕见的完整度**。
