# Runtime 行为规范

## 1. Runtime 概述

Runtime 是 Input Script Runtime 系统的核心组件，负责管理输入采集、脚本执行和 WebSocket 通信。它以 Android Service 形式运行，确保即使在 UI 组件（Activity）被销毁时也能持续处理输入。

## 2. 核心职责

Runtime 承担以下核心职责：

### 2.1 输入采集与处理

- **多源输入采集**：从传感器、触摸输入、游戏手柄等多种来源收集原始输入数据
- **帧率控制**：确保输入帧生成速率稳定在 60 FPS 左右
- **输入预处理**：对原始输入数据进行滤波、归一化等预处理操作

### 2.2 脚本执行

- **Profile 加载**：根据当前配置加载对应的 Profile 和 JavaScript 脚本
- **脚本执行环境**：提供基于 WebView 的安全沙箱环境
- **输入帧生成**：执行脚本将预处理后的输入转换为标准化的 InputFrame

### 2.3 WebSocket 通信

- **连接管理**：建立和维护与后端的 WebSocket 连接
- **消息序列化**：将 InputFrame 转换为 JSON 格式
- **消息发送**：将序列化后的消息发送到后端
- **心跳机制**：定期发送心跳包以保持连接活跃

## 3. 执行模型

### 3.1 输入帧处理流程

```
原始输入 → 预处理 → 脚本执行 → InputFrame 生成 → WebSocket 发送
```

1. **原始输入**：从硬件设备收集的原始传感器数据和触摸事件
2. **预处理**：
   - 传感器数据：滤波、校准、归一化
   - 触摸输入：坐标映射、手势识别
   - 游戏手柄：按键状态转换
3. **脚本执行**：将预处理后的输入传递给 JavaScript 脚本，执行自定义映射逻辑
4. **InputFrame 生成**：脚本返回标准化的输入帧数据
5. **WebSocket 发送**：将 InputFrame 序列化并通过 WebSocket 发送

### 3.2 frameId 语义

- **单调递增**：frameId 从 1 开始，每次生成新的输入帧时自动递增
- **唯一标识**：每个 InputFrame 都有一个唯一的 frameId
- **顺序保证**：后端可以通过 frameId 检测和处理乱序帧
- **环绕处理**：当 frameId 达到最大值时，会重置为 1 并继续递增

### 3.3 脚本执行环境

#### 3.3.1 执行上下文

- **基于 WebView**：使用 Android WebView 作为 JavaScript 执行引擎
- **安全沙箱**：限制脚本访问设备资源，仅提供必要的 API
- **内存限制**：单个脚本执行内存限制为 64MB
- **执行超时**：单个脚本执行时间超过 100ms 时会被强制终止

#### 3.3.2 提供的 API

| API 名称 | 描述 | 参数 | 返回值 |
|---------|------|------|--------|
| `update(rawInput)` | 主入口函数，接收原始输入数据 | `rawInput`：预处理后的原始输入对象 | 标准化的 InputFrame 对象 |
| `getState()` | 获取当前输入状态 | 无 | 当前输入状态对象 |
| `setState(newState)` | 设置输入状态 | `newState`：新的输入状态对象 | 无 |
| `log(message)` | 输出日志 | `message`：日志内容 | 无 |

## 4. 帧率控制

### 4.1 目标帧率

- **默认目标**：60 FPS
- **可配置性**：支持通过配置文件调整目标帧率
- **动态调整**：在设备性能不足时自动降低帧率

### 4.2 帧率监控

- **实时监控**：Runtime 实时监控实际帧率
- **统计报告**：定期生成帧率统计报告，包含平均值、最小值、最大值
- **性能警告**：当帧率持续低于目标帧率的 80% 时，记录警告日志

## 5. 资源管理

### 5.1 内存管理

- **脚本实例池**：维护有限数量的脚本实例，避免频繁创建和销毁
- **定期清理**：定期清理不再使用的资源和缓存
- **内存监控**：监控内存使用情况，当接近阈值时触发垃圾回收

### 5.2 CPU 管理

- **低功耗模式**：在设备处于低电量状态时自动降低 CPU 使用率
- **后台优化**：当应用处于后台时，降低输入采集频率
- **动态调度**：根据设备负载动态调整输入处理优先级

## 6. 可靠性保障

### 6.1 脚本异常处理

- **超时保护**：单个脚本执行超过 100ms 时强制终止
- **异常捕获**：捕获并记录脚本执行过程中的所有异常
- **自动回退**：当脚本连续多次执行失败时，自动切换到默认 Profile

### 6.2 WebSocket 连接可靠性

- **自动重连**：WebSocket 连接断开时自动尝试重连
- **重连策略**：采用指数退避算法，初始重连间隔为 1s，最大间隔为 60s
- **连接状态监控**：实时监控 WebSocket 连接状态
- **消息缓存**：在连接断开期间缓存最多 100 个输入帧，连接恢复后批量发送

### 6.3 数据完整性

- **输入帧验证**：在发送前验证 InputFrame 数据的完整性和格式正确性
- **校验和机制**：可选的校验和字段用于检测数据传输错误
- **重传机制**：支持对丢失的关键帧进行重传请求

## 7. 与其他组件的交互

### 7.1 与 Activity 的交互

- **启动控制**：Activity 可以启动、停止和配置 Runtime Service
- **状态同步**：Runtime 定期向 Activity 报告当前状态
- **配置更新**：Activity 可以动态更新 Runtime 配置

### 7.2 与 Profile 系统的交互

- **Profile 加载**：根据配置加载指定的 Profile
- **Profile 切换**：支持动态切换 Profile，无需重启 Runtime
- **Profile 验证**：在加载前验证 Profile 的完整性和正确性

### 7.3 与 Script Engine 的交互

- **脚本加载**：将 Profile 中的 JavaScript 脚本加载到 Script Engine
- **输入传递**：将预处理后的输入数据传递给脚本
- **结果获取**：获取脚本执行生成的 InputFrame

## 8. 性能指标

| 指标 | 目标值 | 警告阈值 | 错误阈值 |
|------|--------|----------|----------|
| 输入帧生成率 | 60 FPS | < 48 FPS | < 30 FPS |
| 脚本执行时间 | < 10ms | > 50ms | > 100ms |
| WebSocket 延迟 | < 50ms | > 200ms | > 500ms |
| 内存使用率 | < 100MB | > 150MB | > 200MB |
| CPU 使用率 | < 10% | > 25% | > 50% |

## 9. 关键算法

### 9.1 帧率控制算法

采用基于时间差的帧率控制算法，确保输入帧生成速率稳定：

1. 记录上一帧生成时间
2. 计算当前帧应生成的时间窗口
3. 根据实际时间与目标时间的差异调整处理速度
4. 必要时丢弃冗余输入或插入空帧以保持稳定帧率

### 9.2 输入滤波算法

对传感器数据采用卡尔曼滤波算法，减少噪声影响：

- 适用于陀螺仪、加速度计等传感器数据
- 动态调整滤波参数以适应不同使用场景
- 平衡响应速度和噪声抑制效果

### 9.3 WebSocket 重连算法

采用指数退避算法处理 WebSocket 重连：

```
reconnectInterval = min(initialInterval * (2 ^ attempt), maxInterval)
```

- `initialInterval`：初始重连间隔（1s）
- `attempt`：当前重连尝试次数
- `maxInterval`：最大重连间隔（60s）

## 10. 配置选项

Runtime 支持以下配置选项，可通过配置文件或运行时 API 进行调整：

| 配置项 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `targetFps` | integer | 60 | 目标帧率 |
| `scriptTimeout` | integer | 100 | 脚本执行超时时间（ms） |
| `maxReconnectAttempts` | integer | 10 | 最大重连尝试次数 |
| `initialReconnectInterval` | integer | 1000 | 初始重连间隔（ms） |
| `maxReconnectInterval` | integer | 60000 | 最大重连间隔（ms） |
| `frameBufferSize` | integer | 100 | 连接断开时的帧缓存大小 |
| `logLevel` | string | "info" | 日志级别 |

## 11. 监控与日志

### 11.1 日志类型

- **系统日志**：记录 Runtime 启动、停止、配置更新等系统事件
- **性能日志**：记录帧率、脚本执行时间、WebSocket 延迟等性能指标
- **错误日志**：记录脚本执行错误、WebSocket 连接失败等错误事件
- **调试日志**：记录详细的调试信息，仅在调试模式下启用

### 11.2 监控接口

Runtime 提供以下监控接口：

- **状态查询**：允许外部组件查询当前 Runtime 状态
- **性能统计**：提供实时性能统计数据
- **事件监听**：支持监听 Runtime 关键事件

## 12. 版本兼容性

### 12.1 向后兼容性

- **输入格式兼容**：保证对旧版本 Profile 脚本的向后兼容
- **协议格式兼容**：支持不同版本 InputFrame 格式的解析
- **配置兼容**：支持旧版本配置文件格式

### 12.2 向前兼容性

- **渐进式更新**：支持逐步更新到新版本功能
- **特性检测**：支持检测后端支持的特性并动态调整行为
- **优雅降级**：当遇到不支持的特性时，优雅降级到基础功能

## 13. 安全考虑

### 13.1 脚本安全

- **沙箱环境**：脚本在隔离的 WebView 环境中执行，无法访问设备资源
- **API 限制**：仅暴露必要的 API 给脚本，限制潜在风险
- **输入验证**：严格验证脚本返回的 InputFrame 数据格式

### 13.2 通信安全

- **加密传输**：支持通过 WSS（WebSocket Secure）进行加密通信
- **认证机制**：支持 WebSocket 连接的认证和授权
- **消息完整性**：可选的消息签名机制，确保消息未被篡改

### 13.3 数据隐私

- **数据最小化**：仅发送必要的输入数据，不收集额外敏感信息
- **本地处理**：输入数据在本地处理，不存储原始数据
- **透明化**：向用户明确说明数据收集和使用情况
