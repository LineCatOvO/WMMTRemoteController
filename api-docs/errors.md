# 错误模型与回退策略

## 1. 错误分类

Input Script Runtime 系统将错误分为以下几类：

### 1.1 WebSocket 错误

| 错误类型 | 错误码 | 描述 | 示例 |
|----------|--------|------|------|
| **连接错误** | WS_CONNECT_ERROR | 无法建立 WebSocket 连接 | 网络不可用、服务器地址错误 |
| **断开错误** | WS_DISCONNECT_ERROR | WebSocket 连接意外断开 | 服务器重启、网络中断 |
| **超时错误** | WS_TIMEOUT_ERROR | WebSocket 操作超时 | 发送超时、接收超时 |
| **协议错误** | WS_PROTOCOL_ERROR | WebSocket 协议违反 | 无效的消息格式、不符合规范的数据 |
| **认证错误** | WS_AUTH_ERROR | WebSocket 认证失败 | 无效的认证信息 |

### 1.2 Profile 相关错误

| 错误类型 | 错误码 | 描述 | 示例 |
|----------|--------|------|------|
| **加载错误** | PROFILE_LOAD_ERROR | 无法加载 Profile | Profile 目录不存在、权限不足 |
| **验证错误** | PROFILE_VALIDATION_ERROR | Profile 验证失败 | 缺少必需字段、格式错误 |
| **兼容性错误** | PROFILE_COMPATIBILITY_ERROR | Profile 不兼容 | API 版本不匹配、Runtime 版本过低 |
| **初始化错误** | PROFILE_INIT_ERROR | Profile 初始化失败 | init() 方法执行错误 |

### 1.3 脚本执行错误

| 错误类型 | 错误码 | 描述 | 示例 |
|----------|--------|------|------|
| **语法错误** | SCRIPT_SYNTAX_ERROR | JavaScript 语法错误 | 缺少括号、无效的变量名 |
| **执行错误** | SCRIPT_EXECUTION_ERROR | 脚本执行时抛出异常 | 引用未定义的变量、函数调用错误 |
| **超时错误** | SCRIPT_TIMEOUT_ERROR | 脚本执行超时 | 无限循环、复杂计算耗时过长 |
| **内存溢出** | SCRIPT_MEMORY_ERROR | 脚本内存使用超出限制 | 创建大量对象、内存泄漏 |
| **API 调用错误** | SCRIPT_API_ERROR | 调用无效 API | 使用不存在的函数、参数类型错误 |

### 1.4 输入处理错误

| 错误类型 | 错误码 | 描述 | 示例 |
|----------|--------|------|------|
| **传感器错误** | INPUT_SENSOR_ERROR | 传感器数据获取失败 | 传感器不可用、权限被拒绝 |
| **预处理错误** | INPUT_PREPROCESS_ERROR | 输入预处理失败 | 无效的输入数据、预处理算法错误 |
| **帧生成错误** | INPUT_FRAME_ERROR | InputFrame 生成失败 | 脚本返回无效数据、缺少必需字段 |

### 1.5 系统级错误

| 错误类型 | 错误码 | 描述 | 示例 |
|----------|--------|------|------|
| **配置错误** | SYSTEM_CONFIG_ERROR | 系统配置错误 | 无效的配置文件、缺少必需配置项 |
| **资源错误** | SYSTEM_RESOURCE_ERROR | 系统资源不足 | 内存不足、CPU 过载 |
| **权限错误** | SYSTEM_PERMISSION_ERROR | 缺少必要权限 | 网络权限、传感器权限 |
| **崩溃错误** | SYSTEM_CRASH_ERROR | 系统崩溃 | 未捕获的异常、致命错误 |

## 2. 错误处理机制

### 2.1 错误传播流程

```
错误发生 → 错误捕获 → 错误分类 → 错误处理 → 回退策略 → 错误日志
```

1. **错误发生**：在系统各个组件中产生错误
2. **错误捕获**：通过 try-catch 块、事件监听器等机制捕获错误
3. **错误分类**：根据错误类型和错误码进行分类
4. **错误处理**：执行相应的错误处理逻辑
5. **回退策略**：根据错误类型执行适当的回退策略
6. **错误日志**：记录错误信息到日志系统

### 2.2 错误信息格式

所有错误信息遵循以下格式：

```json
{
  "errorCode": "ERROR_CODE",
  "message": "错误描述",
  "timestamp": 1234567890,
  "component": "组件名称",
  "details": {
    // 详细错误信息
  },
  "stackTrace": "堆栈跟踪（可选）"
}
```

## 3. 回退策略

### 3.1 WebSocket 错误回退

| 错误类型 | 回退策略 | 重试逻辑 |
|----------|----------|----------|
| **连接错误** | 等待网络恢复后自动重试 | 指数退避算法：1s → 2s → 4s → ... → 60s |
| **断开错误** | 立即尝试重连 | 相同的指数退避算法 |
| **超时错误** | 重新发送消息，限制重试次数 | 最多重试 3 次，每次间隔 500ms |
| **协议错误** | 断开连接并重新初始化 | 重新建立连接，重置状态 |
| **认证错误** | 停止重试，通知用户 | 无重试，需要用户干预 |

### 3.2 Profile 错误回退

| 错误类型 | 回退策略 |
|----------|----------|
| **加载错误** | 切换到默认 Profile |
| **验证错误** | 标记为无效 Profile，切换到默认 Profile |
| **兼容性错误** | 记录警告，切换到默认 Profile |
| **初始化错误** | 切换到默认 Profile，保留当前 Profile 作为备选 |

### 3.3 脚本执行错误回退

| 错误类型 | 回退策略 | 重试逻辑 |
|----------|----------|----------|
| **语法错误** | 切换到默认 Profile，标记当前 Profile 为无效 | 无重试，需要修复脚本 |
| **执行错误** | 重试执行，限制重试次数 | 最多重试 3 次，每次间隔 100ms |
| **超时错误** | 终止当前脚本，切换到默认 Profile | 无重试，需要优化脚本 |
| **内存溢出** | 终止当前脚本，释放内存，切换到默认 Profile | 无重试，需要优化脚本 |
| **API 调用错误** | 重试执行，限制重试次数 | 最多重试 3 次，每次间隔 100ms |

### 3.4 输入处理错误回退

| 错误类型 | 回退策略 |
|----------|----------|
| **传感器错误** | 使用默认值或上一帧数据，通知用户 |
| **预处理错误** | 使用原始输入数据，跳过预处理 |
| **帧生成错误** | 使用上一帧数据，记录警告 |

### 3.5 系统级错误回退

| 错误类型 | 回退策略 |
|----------|----------|
| **配置错误** | 使用默认配置，记录警告 |
| **资源错误** | 降低性能设置，如降低帧率、减少日志级别 |
| **权限错误** | 请求用户授予权限，否则使用受限功能 |
| **崩溃错误** | 重启 Runtime Service，恢复到默认状态 |

## 4. 错误日志与监控

### 4.1 日志级别

系统支持以下日志级别：

| 级别 | 描述 | 使用场景 |
|------|------|----------|
| **DEBUG** | 详细调试信息 | 开发阶段、问题排查 |
| **INFO** | 一般信息 | 系统状态、正常操作 |
| **WARN** | 警告信息 | 潜在问题、非致命错误 |
| **ERROR** | 错误信息 | 致命错误、需要立即处理的问题 |
| **FATAL** | 严重错误 | 导致系统崩溃的错误 |

### 4.2 日志记录内容

每条日志记录包含以下信息：

- 时间戳
- 日志级别
- 组件名称
- 错误码
- 错误描述
- 详细上下文信息
- 可选的堆栈跟踪

### 4.3 日志存储

- **运行时日志**：存储在内存中，最多保存最近 1000 条日志
- **持久化日志**：重要日志（WARN 及以上）写入文件，保留最近 7 天的日志
- **日志旋转**：定期压缩和清理旧日志文件

### 4.4 监控指标

系统监控以下与错误相关的指标：

| 指标 | 描述 | 单位 |
|------|------|------|
| **错误率** | 错误发生频率 | % |
| **平均恢复时间** | 从错误中恢复的平均时间 | ms |
| **回退次数** | 执行回退策略的次数 | 次 |
| **崩溃次数** | 系统崩溃次数 | 次 |
| **Profile 切换次数** | 因错误切换 Profile 的次数 | 次 |

## 5. 错误通知机制

### 5.1 内部通知

- **组件间通信**：通过事件总线发送错误事件
- **状态更新**：更新系统状态，反映当前错误情况
- **监控告警**：当错误率超过阈值时，触发告警

### 5.2 外部通知

- **WebSocket 消息**：向客户端发送错误通知
- **系统通知**：在设备上显示系统通知
- **日志上报**：将关键错误上报到远程日志服务器

## 6. 错误恢复机制

### 6.1 自动恢复

- **连接恢复**：WebSocket 断开后自动重连
- **Profile 切换**：自动切换到默认 Profile
- **资源释放**：自动释放占用的资源
- **Service 重启**：系统崩溃后自动重启 Service

### 6.2 手动恢复

- **用户干预**：提示用户采取手动操作，如检查网络连接、授予权限
- **配置调整**：允许用户调整配置，如降低性能设置
- **Profile 管理**：允许用户手动切换 Profile

## 7. 错误处理最佳实践

### 7.1 对于 Profile 开发者

- **防御性编程**：在脚本中添加适当的错误处理
- **输入验证**：验证所有输入参数的有效性
- **资源管理**：及时释放不再使用的资源
- **性能优化**：避免复杂计算和无限循环
- **错误日志**：使用 log() 函数记录关键操作和错误

### 7.2 对于 Runtime 开发者

- **全面测试**：测试各种错误场景
- **优雅降级**：在错误情况下提供基本功能
- **详细日志**：记录完整的错误信息，便于调试
- **监控告警**：实时监控系统状态，及时发现问题
- **定期维护**：定期清理日志，优化错误处理逻辑

## 8. 示例错误场景

### 8.1 WebSocket 连接失败场景

```
1. Runtime 尝试建立 WebSocket 连接
2. 网络不可用，连接失败
3. 触发 WS_CONNECT_ERROR 错误
4. 执行回退策略：等待 1s 后重试
5. 连续重试 5 次后，仍无法连接
6. 降低重试频率到最大值 60s
7. 记录 ERROR 级别的日志
8. 向用户显示网络连接错误通知
```

### 8.2 脚本执行超时场景

```
1. Runtime 调用脚本的 update() 方法
2. 脚本执行复杂计算，超过 100ms 超时时间
3. 触发 SCRIPT_TIMEOUT_ERROR 错误
4. 终止当前脚本执行
5. 切换到默认 Profile
6. 记录 ERROR 级别的日志，包含脚本名称和超时时间
7. 更新监控指标：增加脚本超时次数
```

### 8.3 Profile 验证失败场景

```
1. Runtime 尝试加载新的 Profile
2. profile.json 缺少必需的 author 字段
3. 触发 PROFILE_VALIDATION_ERROR 错误
4. 标记该 Profile 为无效
5. 切换到默认 Profile
6. 记录 WARN 级别的日志，包含具体的验证失败原因
7. 更新监控指标：增加 Profile 验证失败次数
```

## 9. 错误码参考

### 9.1 WebSocket 错误码

| 错误码 | 数值 | HTTP 状态码映射 |
|--------|------|----------------|
| WS_CONNECT_ERROR | 1001 | 503 Service Unavailable |
| WS_DISCONNECT_ERROR | 1002 | 400 Bad Request |
| WS_TIMEOUT_ERROR | 1003 | 408 Request Timeout |
| WS_PROTOCOL_ERROR | 1004 | 400 Bad Request |
| WS_AUTH_ERROR | 1005 | 401 Unauthorized |

### 9.2 Profile 错误码

| 错误码 | 数值 |
|--------|------|
| PROFILE_LOAD_ERROR | 2001 |
| PROFILE_VALIDATION_ERROR | 2002 |
| PROFILE_COMPATIBILITY_ERROR | 2003 |
| PROFILE_INIT_ERROR | 2004 |

### 9.3 脚本错误码

| 错误码 | 数值 |
|--------|------|
| SCRIPT_SYNTAX_ERROR | 3001 |
| SCRIPT_EXECUTION_ERROR | 3002 |
| SCRIPT_TIMEOUT_ERROR | 3003 |
| SCRIPT_MEMORY_ERROR | 3004 |
| SCRIPT_API_ERROR | 3005 |

### 9.4 输入处理错误码

| 错误码 | 数值 |
|--------|------|
| INPUT_SENSOR_ERROR | 4001 |
| INPUT_PREPROCESS_ERROR | 4002 |
| INPUT_FRAME_ERROR | 4003 |

### 9.5 系统错误码

| 错误码 | 数值 |
|--------|------|
| SYSTEM_CONFIG_ERROR | 5001 |
| SYSTEM_RESOURCE_ERROR | 5002 |
| SYSTEM_PERMISSION_ERROR | 5003 |
| SYSTEM_CRASH_ERROR | 5004 |

## 10. 结论

Input Script Runtime 系统采用了全面的错误处理机制，确保在各种错误情况下能够优雅地处理和恢复。通过详细的错误分类、明确的回退策略、完整的日志记录和监控机制，系统能够在保证稳定性的同时，提供良好的用户体验。

开发者在编写 Profile 和脚本时，应该遵循错误处理的最佳实践，确保系统在各种情况下都能正常运行。同时，系统管理员应该定期监控错误日志和指标，及时发现和解决潜在问题，确保系统的长期稳定运行。