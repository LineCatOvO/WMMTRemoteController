# 远程赛车输入控制系统  
**需求文档（v2.0）**

---

## 1. 项目概述

### 1.1 项目目的

本项目用于实现一个明确的目标：

> **使用手机作为控制器，远程控制另一台设备上的赛车游戏。**

手机通过触控和陀螺仪采集用户操作，将操作实时发送到远程设备，由远程设备将其作为真实输入执行，游戏本身无需任何修改。

---

### 1.2 项目定位

- 本项目是一个**输入系统**
- 不负责画面或音频传输
- 不修改游戏逻辑
- 不依赖特定游戏

系统只关注**输入的采集、传输与执行**。

---

## 2. 系统总体架构

### 2.1 架构概览

```
[安卓客户端]
  ├─ 输入采集（触控 / 陀螺仪）
  ├─ 输入处理与映射
  ├─ 浮窗 UI 与配置
  └─ WebSocket 通信
        ↓
[Node.js 服务端]
  ├─ 输入状态维护
  └─ 系统级输入执行
        ↓
[赛车游戏]
```

---

### 2.2 架构原则

- 客户端为**强逻辑端**
- 服务端为**输入执行端**
- 服务端不理解游戏语义
- 服务端不管理输入映射
- 输入边界以**设备输入语义**为准（键盘 / 鼠标 / 手柄）
- 所有可配置内容集中在客户端

---

## 3. 输入系统总体要求

### 3.1 输入刷新频率

- 系统必须支持 **不低于 125Hz** 的输入更新频率  
- 系统设计应允许在性能允许的情况下提升至 **250Hz**

该要求为设计上限，不要求当前阶段全部实现。

---

### 3.2 输入模型

- 输入系统以**状态驱动**为核心  
- 不以单次事件（keydown / keyup）作为主要模型  
- 所有输入设备均以“当前状态”为准  

该模型适用于手柄、陀螺仪、模拟量输入。

---

### 3.3 输入平滑与曲线映射

客户端应支持：

- 连续输入的平滑处理  
- 死区设置  
- 非线性映射（如指数曲线、灵敏度曲线）

用于提升赛车操控手感。

---

## 4. 安卓客户端需求

### 4.1 平台选择

移动端仅支持安卓平台。

原因：

- 安卓与苹果是主要移动平台
- 苹果开发存在设备成本和账号成本
- 对个人项目不友好

结论：

> **移动端 = 安卓客户端**

---

### 4.2 客户端运行模式

- 基于 Android Service 实现
- 可在后台持续运行
- 不依赖前台 Activity 存活

---

### 4.3 浮窗与操作界面

- 客户端必须支持系统级浮窗（Overlay）
- 控制界面可覆盖在其他应用之上
- 不影响远程设备上的游戏运行

---

### 4.4 操作 UI 要求

- 支持自定义按钮布局
- 支持滑块、虚拟摇杆等控件
- UI 可针对不同游戏单独配置
- UI 与输入映射强绑定

---

### 4.5 运行时 UI 编辑

- 操作 UI 应支持运行时调整
- 支持在不重启客户端的情况下：
  - 调整布局
  - 修改绑定
  - 调整灵敏度

---

### 4.6 输入采集

#### 4.6.1 触控输入

- 点击
- 长按
- 滑动
- 多区域触控

---

#### 4.6.2 陀螺仪输入

- 采集手机旋转数据
- 用于模拟赛车方向盘
- 支持连续输入
- 支持校准

---

### 4.7 陀螺仪处理要求

客户端必须：

- 直接使用系统传感器 API
- 可控制采样频率
- 支持滤波与平滑
- 输出稳定、低抖动的数据
- 延迟可控

---

### 4.8 输入映射与配置

- 客户端负责全部输入映射逻辑
- UI 控件直接映射为设备输入
- 支持：
  - 键盘输入
  - 鼠标输入
  - 手柄输入

客户端输出的是**最终输入状态**。

---

### 4.9 输入调试能力

客户端应提供输入调试模式，用于：

- 实时显示陀螺仪数值
- 显示映射后的输入状态
- 辅助调试抖动、漂移和延迟问题

---

### 4.10 多配置管理

- 客户端应支持多套输入配置
- 支持快速切换
- 用于不同游戏或不同手感需求

---

### 4.11 网络通信

- 使用 WebSocket 协议
- 支持配置：
  - 服务端 IP
  - 服务端端口
- 支持断线重连
- 支持心跳检测

---

### 4.12 服务端设置管理

- 服务端暴露设置接口
- 安卓客户端可读取和修改服务端配置
- 所有可配置内容集中在客户端完成
- 服务端无需本地配置界面

---

### 4.13 开发方式

安卓客户端采用**原生开发**。

跨平台方案（Flutter / React Native / Unity）不作为本项目实现方案。

---

## 5. Node.js 服务端需求

### 5.1 服务端定位

服务端是**输入执行器**，不是逻辑中心。

---

### 5.2 服务端职责

- 接收客户端输入数据
- 维护输入设备当前状态
- 将状态写入系统输入接口
- 保证输入连续、稳定

---

### 5.3 服务端不负责的内容

- 输入映射
- 游戏语义
- UI 管理
- 客户端行为判断

---

### 5.4 输入模型

- 服务端维护轻量输入状态
- 以固定频率写入输入设备
- 不依赖事件顺序

---

### 5.5 安全回退机制

- 当客户端断开或输入中断时
- 服务端应自动回退至安全输入状态
- 防止油门、方向等输入卡死

---

### 5.6 输入执行与通信解耦

- 输入执行逻辑应与网络通信解耦
- 允许未来由不同来源驱动输入状态

---

### 5.7 设置接口

- 服务端提供设置接口
- 用于运行参数调整
- 接口仅供客户端调用

---

### 5.8 部署与分发

- 服务端基于 Node.js
- 可打包为单一可执行文件
- 用户无需安装运行环境
- 目标平台：Windows

---

## 6. 性能与可观测性要求

### 6.1 延迟要求

- 输入链路端到端延迟应尽可能低
- 系统应支持测量输入延迟

---

## 7. 使用场景

- 手机旋转 → 赛车转向
- 屏幕按钮 → 加速 / 刹车
- 滑块 → 油门控制

---

## 8. 当前阶段目标

第一阶段仅实现：

- 单客户端
- 单服务端
- 基本赛车控制
- 稳定、低延迟输入链路

---

## 9. 后续扩展方向（非当前需求）

- 多游戏支持
- 输入录制与回放
- 非赛车类游戏支持
- 自动化输入来源