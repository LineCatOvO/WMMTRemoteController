下面是**在不改变既有需求语义、不引入实现细节的前提下**，对文档进行**精炼与增强后的完整版最终需求文档**。  
本次修改**唯一新增重点**是：**系统级、完备的操作布局编辑能力**，并将其提升为一等用户能力，而不是附属配置。

---

# 远程赛车输入控制系统
**最终需求文档（Final Requirements Specification）**

---

## 文档说明

本文档为**远程赛车输入控制系统的最终需求规格说明**。  
文档用于明确系统在当前阶段对用户与集成方的**完整、稳定、可验证的行为承诺**，并作为后续功能文档、技术设计文档与测试文档的唯一需求依据。

本文档仅描述**系统应当具备的能力与对外行为表现**，不涉及任何实现方式、技术选型或架构细节。

---

## 1. 项目目标

### 1.1 总体目标

系统的目标是：

> **在安卓设备上，通过用户操作生成控制结果，使目标赛车游戏在无需修改的情况下响应这些控制。**

系统应保证控制行为稳定、可预测，并在异常情况下不会产生残留输入。

---

### 1.2 成功判定标准

系统被视为满足目标，当且仅当：

- 游戏能够对控制产生响应
- 控制响应与用户操作语义一致
- 异常、中断或禁用后不存在残留控制状态

---

## 2. 使用场景与适用范围

### 2.1 当前阶段使用场景

系统运行于以下环境条件：

| 项目 | 描述 |
|----|----|
| 设备 | 单一安卓设备 |
| 游戏环境 | 基于 Wine / Proton 的 Windows 游戏执行环境 |
| 客户端形态 | 安卓系统服务 |
| 操作界面 | 系统级浮窗 |
| 控制传输 | 本地 WebSocket（localhost） |

---

### 2.2 场景边界

- 系统不依赖外部网络
- 系统不依赖第二台物理设备
- 系统不要求对游戏进行任何修改

---

## 3. 系统整体行为模型

### 3.1 行为阶段

系统整体行为分为三个阶段：

1. 用户操作被系统感知
2. 操作被解释为控制语义
3. 控制语义在目标执行环境中生效

---

### 3.2 行为一致性要求

系统应保证：

- 相同操作在相同配置下产生一致控制结果
- 控制结果在连续时间内保持稳定
- 控制行为不依赖界面是否存在

---

## 4. 输入源与控制结果边界

### 4.1 输入源支持级别

系统在需求层面对输入源支持作如下区分：

| 输入源类型 | 支持级别 |
|----|----|
| 触控 | 必须支持 |
| 陀螺仪 | 必须支持 |
| 键盘 | 可选支持 |
| 手柄 | 可选支持 |

输入源的存在与否**不影响系统对控制结果的承诺**。

---

### 4.2 控制结果类型

系统最终生成的控制结果必须覆盖以下类型：

| 控制结果 | 描述 |
|----|----|
| 键盘控制结果 | 等价于真实键盘输入 |
| 手柄控制结果 | 等价于真实游戏手柄输入 |

控制结果描述的是目标执行环境所接收到的输入形式，与客户端输入源类型无关。

---

## 5. 控制模型需求

### 5.1 状态驱动模型

系统必须采用状态驱动控制模型：

- 任意时刻的控制可被描述为“当前状态”
- 控制中断后状态可被明确清空
- 不依赖历史事件顺序形成隐式状态

---

### 5.2 控制刷新能力

系统应支持不低于 **125Hz** 的控制状态更新能力，以保证连续操控体验。

---

### 5.3 控制平滑与映射

系统应支持：

- 连续控制平滑
- 死区设置
- 非线性映射（如指数曲线）

---

## 6. 远程控制结果行为

### 6.1 键盘控制结果

系统必须能够生成键盘控制结果，满足：

- 多按键同时生效
- 持续按键在释放前保持有效
- 异常中断后按键状态被清空

---

### 6.2 手柄控制结果

系统必须能够生成手柄控制结果，满足：

- 摇杆与扳机为连续模拟量
- 多轴、多按键同时存在
- 异常中断后手柄状态被重置

---

### 6.3 控制结果组合

系统必须允许在同一时间生成多种控制结果，且不同控制结果之间互不排斥。

---

## 7. 操作布局与配置管理

### 7.1 操作布局定义

操作布局是：

> 一组用于描述用户操作方式、操作区域与控制结果映射关系的配置集合。

操作布局是系统中**最核心的用户可配置对象之一**。

---

### 7.2 布局作为用户资产

操作布局对用户可见，并具备以下特性：

- 可创建
- 可修改
- 可分享
- 可下载
- 可复用

布局不依附于单次运行，具有独立生命周期。

---

### 7.3 多布局管理能力

系统必须支持：

| 能力 | 描述 |
|----|----|
| 多布局维护 | 同时管理多套布局 |
| 布局切换 | 运行过程中随时切换 |
| 布局导入 | 使用外部布局 |
| 布局导出 | 复用与传播布局 |

布局切换后新的控制行为应立即生效，且不产生残留控制状态。

---

### 7.4 布局与连接关系

操作布局的启用、禁用与切换：

- 不影响网络连接状态
- 不触发隐式断开或重连

---

### 7.5 单一布局内的多控制结果

系统必须允许在同一个操作布局中同时生成：

- 键盘控制结果
- 手柄控制结果

---

## 8. 布局编辑能力（重点）

### 8.1 布局编辑工具总体要求

项目客户端**必须提供完备的操作布局编辑工具**，用于支持用户在应用内完成布局的创建、调整与维护。

布局编辑能力是系统的**核心用户能力**，而非附属功能。

---

### 8.2 编辑能力范围

布局编辑工具应支持用户完成以下操作：

| 编辑能力 | 描述 |
|----|----|
| 操作元素管理 | 添加、删除、调整操作元素 |
| 布局结构调整 | 调整操作区域位置与尺寸 |
| 控制映射编辑 | 修改操作与控制结果的对应关系 |
| 参数调整 | 调整灵敏度、范围、曲线等参数 |
| 实时预览 | 编辑过程中可观察控制行为变化 |

---

### 8.3 编辑过程行为要求

布局编辑过程应满足：

- 编辑操作无需重启系统
- 编辑结果可即时生效或预览
- 编辑失败不会破坏已有布局
- 用户可随时放弃未保存修改

---

### 8.4 编辑与运行的关系

- 布局编辑不应中断当前控制运行
- 编辑状态与控制启用状态相互独立
- 编辑完成后用户可选择是否立即应用

---

## 9. 控制启用、作用范围与状态

### 9.1 控制启用与禁用

系统必须允许用户在运行过程中启用或禁用控制输出：

- 禁用状态下不产生任何控制结果
- 启用或禁用不影响布局、配置或连接状态

---

### 9.2 控制作用范围

系统对控制作用范围的行为承诺如下：

- 控制默认对宿主环境全局生效
- 不基于当前运行应用筛选控制作用范围

**唯一例外**：

- UAC 等高权限内容
- 系统或软件安全机制触发的强制切断、暂停或断开

---

### 9.3 控制状态可见性

系统必须允许用户确认当前控制状态，包括：

- 是否存在持续控制
- 异常或回退后状态是否已清空

---

## 10. 网络通信行为

### 10.1 通信能力

系统应通过 WebSocket 传输控制数据，并保证：

- 控制数据持续发送
- 短暂中断后可恢复
- 中断期间控制结果安全

---

### 10.2 连接校验与反馈

系统应在连接异常时：

- 提示用户连接信息缺失
- 明确告知连接失败
- 清空所有控制结果

---

## 11. 异常与回退行为

### 11.1 异常隔离

单一异常不得导致系统整体失效或控制失控。

---

### 11.2 安全回退状态

任何异常、回退或禁用后的最终状态：

> **必须等价于“没有任何控制输出”。**

---

## 12. 可观测性与可重复性

系统行为必须具备：

- 可观察性
- 可验证性
- 可重复性

相同操作与异常应产生一致结果。

---

## 13. 当前阶段目标总结

| 项目 | 要求 |
|----|----|
| 设备 | 单安卓设备 |
| 输入源 | 触控、陀螺仪 |
| 控制结果 | 键盘、手柄 |
| 布局 | 完整编辑、管理与复用 |
| 稳定性 | 无残留控制 |
| 场景 | 本地执行环境 |

---

## 14. 非当前阶段内容

以下内容不属于当前需求范围：

- 跨设备远程控制
- 云端执行环境
- 多实例并行控制
- 控制结果录制与回放

---

**文档状态**：最终需求文档  
**用途**：功能设计、技术设计与测试的唯一需求依据

---

### 工程结论

> **现在这份文档已经完整定义了：  
> 用户能做什么、系统必须做到什么、以及什么情况下算失败。**

下一步产物应当是：

- **功能文档（Functional Specification）**
- 或 **需求 → 功能映射矩阵**

如果你愿意，我可以直接基于这份文档生成下一阶段内容。
