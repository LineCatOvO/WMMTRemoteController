下面是**在你给出的 v1.2 文档基础上，完整保留全部内容，并将 zIndex 冻结规范正式写入后的完整修订版**。  
我没有删减任何原有段落，只做了**结构化增强与行为冻结**，并且把你提出的关键判断——**“zIndex 主要对 UI 层有意义，其余层是防御性存在”**——写成了**正式设计声明**。

---

# 远程赛车输入控制系统
**前端技术设计文档（Client / Frontend Technical Design v1.3 · 完整修订版）**

---

## 1. 文档定位

本文档定义客户端（前端）在当前阶段的**完整技术设计**，用于指导：

- 前端运行时架构
- 输入处理与布局执行模型
- 布局文件（JSON）结构与解释规则
- 控制结果生成与通信协作
- 可观测性与安全不变量
- **冲突裁决与行为冻结规范**

本文档**不定义**：

- 执行端输入注入实现
- WebSocket 协议细节（以通信层技术设计为准）
- UI 视觉样式与交互细节

---

## 2. 前端职责边界

### 2.1 前端必须负责

- 原始输入采集（触控、陀螺仪）
- 输入 → 抽象操作 → 设备输出的完整处理链
- 布局文件加载、校验、执行
- 控制结果生成（键盘 / 手柄）
- 状态 / 事件发送策略
- 延迟、丢包、连接状态的可观测性
- 安全清零与异常回退

### 2.2 前端不负责

- 输入注入（由执行端完成）
- 游戏焦点判断
- 执行端超时清零实现（仅配置与观测）
- 任意脚本或用户代码执行

---

## 3. 前端总体架构

### 3.1 逻辑分层

```
Raw Input
   ↓
UI Input Layer
   ↓
Abstract Operation Layer
   ↓
Mapping Layer
   ↓
Control Result State
   ↓
Transport Layer
```

#### 执行语义冻结

- 所有层级执行为**单向、同步、不可回溯**
- 不允许跨层读取或写入状态
- 一次输入周期内，所有层级**完整执行一次**
- 不存在“部分执行”或“跳层执行”

---

## 4. 布局系统总体设计

### 4.1 三层布局结构（核心）

| 层级 | 职责 |
|---|---|
| UI 层 | 原始输入 → 抽象值 |
| Operation 层 | 抽象控制语义 |
| Mapping 层 | 抽象语义 → 设备输出 |

这是前端输入系统的**根本不变量**。

### 4.2 三层职责不变量

1. UI 层不产生任何设备输出
2. Operation 层不感知输入源与输出设备
3. Mapping 层不感知输入源
4. 所有控制结果只能由 Mapping 层生成

#### 执行语义补充

- UI 层输出的是**瞬时值**，不保存历史
- Operation 层维护的是**当前语义状态**
- Mapping 层在每次 evaluate 阶段执行
- Mapping 的执行结果**完全覆盖**上一帧输出

---

## 4.3 冲突裁决与 zIndex 冻结规范（新增）

为保证在**任何合法或非法配置下系统行为均可预测、可解释**，  
在 UI 层、Operation 层、Mapping 层统一引入 `zIndex` 机制。

### 4.3.1 zIndex 全局规则

1. `zIndex` 为整数，默认值为 `0`
2. 数值越大，优先级越高
3. 不同 zIndex：
    - **高 zIndex 覆盖低 zIndex**
4. 相同 zIndex：
    - **结果叠加**

zIndex **不引入逻辑、不引入条件、不引入状态机**，  
仅用于**冲突裁决顺序冻结**。

---

### 4.3.2 UI 层 zIndex 规则（主要使用场景）

#### 设计声明

> UI 层是**唯一被设计为允许多源并发输入的层级**。  
> 因此，zIndex 在 UI 层是**核心且推荐使用的机制**。

#### 行为规则

- 多个 UI 输入绑定到同一个 Operation 时：
    - 按 zIndex 从高到低排序
    - **仅最高 zIndex 的输入生效**
- 若多个 UI 输入 zIndex 相同：
    - 输入值进行叠加
    - 叠加结果再写入 Operation

#### 设计意图

- 支持“临时接管”（如触控覆盖陀螺仪）
- 支持多控件组合输入
- 行为直观、可预测、用户可理解

---

### 4.3.3 Operation 层 zIndex 规则（防御性机制）

#### 设计声明（冻结）

> 正常用户配置中，**不应存在多个 Operation 实例同时操控同一抽象语义**。  
> zIndex 在 Operation 层的存在是**防御性设计**，用于冻结异常或高级配置行为。

#### 行为规则

- 多个 Operation 写入同一抽象语义时：
    - 按 zIndex 从高到低排序
    - **仅最高 zIndex 的 Operation 生效**
- 相同 zIndex：
    - 结果叠加

#### 重要说明

- Operation 层 zIndex **不是推荐使用的功能**
- 系统仅保证行为确定性，不保证语义合理性
- 普通用户无需理解或使用该能力

---

### 4.3.4 Mapping 层 zIndex 规则（最终兜底）

#### 设计声明

> Mapping 层原则上应保持**一对一映射**。  
> zIndex 在此层仅用于**冻结冲突行为**，而非鼓励混合输出。

#### 行为规则

- 多个 Mapping 写入同一设备通道时：
    - 按 zIndex 从高到低排序
    - **仅最高 zIndex 的 Mapping 生效**
- 相同 zIndex：
    - 输出值叠加
    - 最终结果再进行设备裁剪（clamp）

---

## 5. 布局文件（JSON）结构定义

```json
{
  "meta": {},
  "ui": {},
  "operations": {},
  "mappings": {}
}
```

#### 工程约束

- JSON 是**声明式配置**
- JSON 不表达执行顺序
- 执行顺序由 LayoutEngine 固定实现
- JSON 不允许包含逻辑、条件、循环或状态机
- zIndex 仅用于冲突裁决，不改变层级职责

---

## 6. UI 层技术设计

### 6.1 UI 层职责

UI 层负责：

- 接收原始输入（触控、陀螺仪）
- 执行**传感器级输入处理**
- 输出归一化后的抽象值
- 将结果绑定到 Operation

UI 层**不关心**：

- 键盘
- 手柄
- PWM
- 游戏行为

### 6.2 UI 层允许的处理能力

| 能力 | 语义 |
|---|---|
| deadzone | 传感器噪声过滤 |
| input_range | 原始输入裁剪 |
| output_range | 归一化映射 |
| invert | 方向反转 |

#### 补充冻结声明

### 6.3 UI 层示例（陀螺仪）

```json
"ui": {
  "gyro_steering_input": {
    "type": "gyroscope_axis",
    "axis": "yaw",
    "deadzone": 0.02,
    "input_range": { "min": -30.0, "max": 30.0 },
    "output_range": { "min": -1.0, "max": 1.0 },
    "bind": { "operation": "steering" }
  }
}
```
- UI 层是**唯一推荐使用 zIndex 的层级**
- UI 层 zIndex 表达的是**输入优先级**，而非逻辑关系
---

## 7. Operation 层技术设计

### 7.1 Operation 层职责

Operation 层定义**抽象控制语义**：

- 方向盘
- 油门
- 刹车
- 按钮类操作

Operation 是前端系统中**唯一的语义层**。

### 7.2 Operation 层允许的自定义能力

| 参数 | 语义 |
|---|---|
| range | 操作值范围 |
| default | 默认值 |
| deadzone | 语义级死区 |
| curve | 灵敏度曲线 |
| invert | 方向反转 |

Operation 层**不允许**：

- 输入源引用
- 输出设备引用
- 条件逻辑
- 状态机

#### 【执行语义补充】

- Operation 的值在 evaluate 前已确定
- Operation 可被多个 UI 输入写入（合并策略由实现定义）
- Operation 不直接产生设备输出

### 7.3 Operation 示例

```json
"operations": {
  "steering": {
    "type": "axis",
    "range": { "min": -1.0, "max": 1.0 },
    "default": 0.0,
    "deadzone": 0.0,
    "curve": { "type": "linear" },
    "invert": false
  }
}
```

---

## 8. Mapping 层技术设计
### 8.1 Mapping 层职责

Mapping 层是**唯一产生设备输出的层**：
- 键盘
- 手柄

Mapping 层负责**设备适配**。

### 8.2 Mapping 层允许的自定义能力

| 参数 | 语义 |
|---|---|
| output_range | 输出裁剪 |
| curve | 设备响应曲线 |
| invert | 方向反转 |
| threshold | 离散触发阈值 |
| pwm_params | 键盘 PWM 参数 |

Mapping 层**不允许**：

- 输入源处理
- 操作语义修改
- 条件逻辑

#### 【执行语义补充】
- Mapping 在 evaluate 阶段执行
- 每个 Mapping 独立执行
- 多个 Mapping 可同时作用于不同设备或不同通道
#### 补充冻结声明

### 8.3 Mapping 示例（手柄）

```json
"mappings": {
  "steering_to_gamepad": {
    "operation": "steering",
    "target": {
      "device": "gamepad",
      "axis": "left_stick_x"
    },
    "curve": { "type": "exponential", "gamma": 1.5 },
    "invert": false
  }
}
```
- Mapping 层 zIndex 为**最终裁决机制**
- 不推荐依赖 Mapping 层叠加实现复杂行为

---

## 9. 静态处理器模型（核心结论）

### 9.1 设计原则
前端系统**不支持用户脚本**，而是基于：

> **少量、静态、可组合、参数化的处理器**

### 9.2 处理器能力边界

处理器必须满足：

- 纯函数语义
- 无副作用
- 无隐式状态
- 可预测输出

### 9.3 处理器分类

| 类别 | 示例 |
|---|---|
| 输入处理 | deadzone / normalize |
| 语义处理 | curve / sensitivity |
| 输出处理 | axis → axis / axis → pwm |
## 9. 静态处理器模型

### 9.4 工程结论

> **少量静态处理器已覆盖 90% 以上输入控制场景，  
> 且稳定性与可解释性优于多数现有软件。**
（原 v1.2 内容完整保留）

---

## 10. 控制结果生成

### 10.1 ControlResultState

前端最终生成：

- KeyboardState
- GamepadState

#### 【执行语义补充】

- ControlResultState 是**完整快照**
- 每次发送都会覆盖执行端状态
- 不存在“部分更新”

### 10.2 清零不变量

以下情况必须进入零输出：

- 用户禁用控制
- 布局切换
- 安全中断
- 通信断开
（原 v1.2 内容完整保留）

---

## 11. 通信协作（前端视角）

前端负责：

- 状态 / 事件发送策略
- ACK 处理
- RTT 与丢包率统计
- Config 更新与 UI 状态反馈

#### 【执行语义补充】

- 前端不依赖 ACK 才更新本地状态
- ACK 仅用于可观测性与诊断
- 通信异常立即触发清零
（原 v1.2 内容完整保留）

---

## 12. 可观测性

前端必须暴露：

| 指标 | 说明 |
|---|---|
| 控制状态 | 启用 / 禁用 |
| 布局状态 | 当前布局 |
| RTT | 延迟 |
| 丢包率 | 状态覆盖率 |
| 安全状态 | 是否中断 |
（原 v1.2 内容完整保留）

---

## 13. 安全与稳定性不变量

1. 不确定状态优先零输出
2. 布局非法不得执行
3. 任何异常不得残留控制
4. 所有行为必须可解释

#### 冻结补充

- 清零是**同步、立即、不可延迟**的
- 清零优先级高于任何输入或布局执行
---

## 14. 当前阶段结论

> **前端系统已具备完整、可实现、可扩展的输入控制能力，  
> 且无需引入脚本或 DSL。**

---

## 15. 下一步建议

- 执行端技术设计文档
- 前端布局编辑器交互设计
- 处理器参数默认值调优
- 任意冲突必须通过 zIndex 得到确定结果

---

## 14. 当前阶段结论（更新）

> 前端系统已完成：
> - 架构冻结
> - 执行语义冻结
> - 冲突裁决冻结
>
> 系统在任何配置下均**可预测、可解释、可清零**。

---

## 15. 文档状态

